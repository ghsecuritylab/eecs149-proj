#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>

#include "app_error.h"
#include "nrf.h"
#include "nrf_delay.h"
#include "nrf_gpio.h"
#include "nrf_log.h"
#include "nrf_log_ctrl.h"
#include "nrf_log_default_backends.h"
#include "nrf_pwr_mgmt.h"
#include "nrf_serial.h"
#include "nrfx_gpiote.h"
#include "nrf_i2s.h"
#include "nrfx_i2s.h"
#include "nrf_drv_i2s.h"

#include "types.h"

#define SCK_PIN 14 // same as BCK
#define LRCK_PIN 15
#define MCK_PIN 13
#define SDOUT_PIN 16 // same as DIN

#define B3_LENGTH 368
#define C4_LENGTH 347
#define D4_FLAT_LENGTH 328
#define D4_LENGTH 310
#define E4_FLAT_LENGTH 292
#define E4_LENGTH 276
#define F4_LENGTH 260
#define G4_FLAT_LENGTH 246
#define G4_LENGTH 232
#define A4_FLAT_LENGTH 219
#define A4_LENGTH 207
#define B4_FLAT_LENGTH 195
#define B4_LENGTH 184
#define C5_LENGTH 174
#define D5_FLAT_LENGTH 164
#define D5_LENGTH 155
#define E5_FLAT_LENGTH 146
#define E5_LENGTH 138
#define F5_LENGTH 130
#define G5_FLAT_LENGTH 123
#define G5_LENGTH 116
#define A5_FLAT_LENGTH 109
#define A5_LENGTH 103
#define B5_FLAT_LENGTH 98
#define B5_LENGTH 92
#define C6_LENGTH 87
#define NO_NOTE_LENGTH 2

#define BUFFER_LENGTH 10

static int16_t B3_array[B3_LENGTH] = {199, 682, 1156, 1628, 2091, 2551, 2995, 3441, 3872, 4297, 4707, 5110, 5499, 5880, 6243, 6603, 6946, 7283, 7604, 7918, 8217, 8509, 8782, 9054, 9310, 9562, 9801, 10036, 10259, 10479, 10685, 10892, 11087, 11281, 11467, 11652, 11828, 12007, 12178, 12351, 12517, 12684, 12845, 13008, 13162, 13321, 13473, 13628, 13776, 13927, 14070, 14214, 14348, 14483, 14608, 14733, 14848, 14962, 15066, 15170, 15263, 15358, 15443, 15527, 15603, 15678, 15744, 15809, 15865, 15921, 15968, 16015, 16053, 16091, 16121, 16150, 16170, 16190, 16200, 16208, 16206, 16203, 16190, 16174, 16149, 16123, 16088, 16052, 16008, 15965, 15914, 15863, 15803, 15743, 15673, 15600, 15516, 15428, 15328, 15224, 15108, 14987, 14854, 14718, 14568, 14415, 14252, 14082, 13902, 13717, 13521, 13321, 13110, 12896, 12673, 12444, 12207, 11965, 11714, 11460, 11198, 10935, 10669, 10396, 10123, 9848, 9572, 9295, 9015, 8733, 8447, 8153, 7853, 7546, 7230, 6909, 6581, 6254, 5927, 5599, 5280, 4968, 4666, 4375, 4092, 3820, 3555, 3294, 3037, 2781, 2527, 2273, 2019, 1768, 1521, 1274, 1033, 798, 570, 349, 138, -64, -258, -449, -630, -807, -978, -1144, -1306, -1463, -1615, -1766, -1909, -2048, -2180, -2306, -2423, -2535, -2635, -2729, -2817, -2903, -2987, -3075, -3165, -3263, -3368, -3483, -3603, -3729, -3859, -3990, -4118, -4245, -4366, -4482, -4592, -4698, -4800, -4899, -4996, -5093, -5189, -5288, -5387, -5486, -5584, -5682, -5776, -5871, -5960, -6047, -6129, -6208, -6282, -6353, -6418, -6482, -6540, -6595, -6645, -6692, -6734, -6774, -6807, -6838, -6862, -6883, -6897, -6907, -6910, -6909, -6902, -6892, -6876, -6858, -6835, -6811, -6785, -6757, -6726, -6696, -6663, -6631, -6597, -6565, -6533, -6504, -6476, -6450, -6427, -6406, -6388, -6372, -6358, -6347, -6338, -6332, -6329, -6329, -6337, -6351, -6374, -6407, -6451, -6508, -6577, -6656, -6748, -6847, -6957, -7075, -7200, -7331, -7470, -7613, -7766, -7923, -8087, -8258, -8435, -8616, -8803, -8995, -9190, -9389, -9593, -9807, -10027, -10257, -10498, -10749, -11011, -11279, -11555, -11839, -12122, -12408, -12691, -12970, -13244, -13513, -13775, -14034, -14280, -14521, -14747, -14963, -15162, -15348, -15515, -15670, -15806, -15932, -16041, -16142, -16229, -16309, -16370, -16386, -16381, -16385, -16381, -16386, -16380, -16388, -16359, -16265, -16143, -16003, -15835, -15653, -15445, -15221, -14973, -14712, -14426, -14129, -13806, -13475, -13121, -12753, -12366, -11969, -11552, -11128, -10682, -10237, -9772, -9302, -8819, -8333, -7837, -7342, -6834, -6334, -5823, -5312, -4798, -4287, -3773, -3266, -2755, -2257, -1756, -1260, -766, -279};
static int16_t C4_array[C4_LENGTH] = {200, 711, 1214, 1712, 2204, 2686, 3158, 3625, 4078, 4522, 4952, 5371, 5776, 6167, 6547, 6916, 7271, 7615, 7943, 8263, 8566, 8857, 9140, 9410, 9671, 9922, 10165, 10400, 10623, 10841, 11052, 11257, 11456, 11651, 11839, 12027, 12210, 12390, 12568, 12742, 12914, 13082, 13248, 13414, 13575, 13736, 13894, 14049, 14199, 14344, 14486, 14620, 14749, 14872, 14989, 15101, 15206, 15306, 15402, 15491, 15576, 15655, 15728, 15796, 15858, 15916, 15969, 16016, 16058, 16096, 16129, 16156, 16178, 16195, 16204, 16208, 16205, 16195, 16178, 16156, 16126, 16093, 16052, 16008, 15960, 15907, 15850, 15788, 15720, 15646, 15563, 15473, 15372, 15264, 15145, 15018, 14881, 14735, 14579, 14416, 14244, 14062, 13871, 13671, 13463, 13247, 13022, 12791, 12551, 12304, 12049, 11785, 11517, 11241, 10961, 10680, 10391, 10102, 9809, 9516, 9222, 8924, 8624, 8317, 8002, 7680, 7349, 7011, 6664, 6317, 5970, 5622, 5283, 4953, 4634, 4326, 4028, 3742, 3463, 3187, 2916, 2646, 2377, 2107, 1839, 1576, 1314, 1058, 808, 566, 333, 110, -103, -308, -508, -698, -884, -1062, -1236, -1404, -1567, -1727, -1882, -2030, -2171, -2304, -2429, -2545, -2651, -2750, -2842, -2932, -3023, -3116, -3216, -3324, -3442, -3568, -3700, -3837, -3976, -4113, -4247, -4375, -4497, -4613, -4724, -4832, -4936, -5039, -5141, -5244, -5350, -5454, -5558, -5662, -5763, -5863, -5959, -6050, -6138, -6220, -6298, -6372, -6441, -6506, -6566, -6622, -6673, -6720, -6762, -6800, -6833, -6860, -6882, -6898, -6907, -6911, -6908, -6900, -6887, -6869, -6848, -6824, -6797, -6768, -6736, -6704, -6670, -6635, -6600, -6566, -6532, -6501, -6472, -6444, -6421, -6400, -6381, -6365, -6352, -6341, -6333, -6329, -6329, -6335, -6349, -6372, -6407, -6454, -6516, -6591, -6678, -6778, -6887, -7007, -7136, -7272, -7415, -7566, -7725, -7891, -8063, -8244, -8430, -8623, -8822, -9025, -9233, -9445, -9665, -9894, -10131, -10382, -10643, -10916, -11199, -11489, -11788, -12090, -12392, -12693, -12988, -13279, -13562, -13840, -14111, -14370, -14620, -14854, -15074, -15277, -15462, -15630, -15779, -15914, -16033, -16139, -16233, -16315, -16376, -16384, -16383, -16383, -16383, -16383, -16383, -16381, -16304, -16181, -16039, -15867, -15675, -15458, -15219, -14958, -14676, -14373, -14051, -13706, -13348, -12966, -12567, -12150, -11717, -11269, -10805, -10330, -9844, -9342, -8835, -8316, -7793, -7263, -6729, -6194, -5653, -5108, -4566, -4021, -3481, -2939, -2407, -1878, -1349, -826, -308};
static int16_t D4_FLAT_array[D4_FLAT_LENGTH] = {200, 740, 1272, 1798, 2317, 2823, 3321, 3811, 4285, 4748, 5195, 5631, 6049, 6455, 6847, 7225, 7590, 7939, 8276, 8596, 8903, 9199, 9482, 9756, 10017, 10272, 10513, 10747, 10973, 11192, 11404, 11611, 11811, 12010, 12205, 12395, 12583, 12767, 12948, 13125, 13301, 13474, 13645, 13814, 13979, 14141, 14296, 14447, 14591, 14729, 14860, 14984, 15102, 15213, 15319, 15419, 15512, 15600, 15682, 15758, 15827, 15890, 15948, 16000, 16046, 16088, 16124, 16153, 16177, 16195, 16205, 16208, 16204, 16192, 16173, 16146, 16113, 16075, 16030, 15981, 15927, 15868, 15804, 15734, 15656, 15570, 15474, 15368, 15252, 15126, 14989, 14842, 14685, 14517, 14340, 14153, 13956, 13749, 13531, 13305, 13069, 12826, 12574, 12312, 12043, 11763, 11479, 11186, 10890, 10589, 10283, 9976, 9666, 9356, 9042, 8726, 8404, 8073, 7734, 7385, 7027, 6661, 6293, 5927, 5560, 5203, 4856, 4523, 4201, 3892, 3594, 3300, 3012, 2726, 2441, 2155, 1871, 1593, 1316, 1045, 782, 526, 282, 48, -173, -389, -596, -794, -987, -1172, -1353, -1526, -1697, -1861, -2018, -2168, -2309, -2440, -2562, -2672, -2775, -2872, -2967, -3063, -3165, -3275, -3395, -3526, -3664, -3808, -3955, -4100, -4242, -4378, -4507, -4628, -4746, -4858, -4968, -5077, -5185, -5295, -5407, -5517, -5627, -5735, -5841, -5943, -6041, -6134, -6221, -6303, -6381, -6453, -6521, -6583, -6640, -6693, -6740, -6783, -6820, -6851, -6876, -6895, -6906, -6910, -6908, -6900, -6886, -6867, -6845, -6818, -6789, -6757, -6724, -6689, -6652, -6615, -6579, -6543, -6509, -6478, -6448, -6423, -6400, -6381, -6364, -6350, -6340, -6332, -6329, -6330, -6340, -6359, -6390, -6434, -6494, -6570, -6659, -6762, -6876, -7002, -7138, -7282, -7435, -7596, -7766, -7943, -8128, -8322, -8522, -8730, -8943, -9161, -9384, -9614, -9854, -10104, -10368, -10643, -10933, -11233, -11541, -11859, -12178, -12498, -12814, -13125, -13428, -13724, -14015, -14293, -14560, -14812, -15047, -15264, -15459, -15637, -15794, -15934, -16057, -16167, -16261, -16344, -16385, -16381, -16384, -16382, -16384, -16381, -16385, -16319, -16192, -16043, -15861, -15657, -15425, -15167, -14886, -14581, -14254, -13903, -13531, -13140, -12724, -12291, -11837, -11368, -10879, -10378, -9865, -9335, -8797, -8248, -7694, -7131, -6565, -5999, -5423, -4849, -4273, -3700, -3127, -2560, -2001, -1441, -886, -338};
static int16_t D4_array[D4_LENGTH] = {200, 771, 1333, 1889, 2436, 2968, 3493, 4005, 4502, 4983, 5450, 5900, 6332, 6753, 7155, 7544, 7914, 8272, 8610, 8934, 9245, 9543, 9829, 10104, 10368, 10620, 10863, 11098, 11325, 11547, 11760, 11971, 12177, 12379, 12578, 12772, 12965, 13151, 13337, 13520, 13700, 13877, 14051, 14219, 14380, 14536, 14684, 14825, 14958, 15085, 15203, 15315, 15421, 15519, 15612, 15697, 15776, 15847, 15912, 15971, 16023, 16069, 16110, 16144, 16171, 16191, 16204, 16208, 16204, 16192, 16171, 16143, 16107, 16064, 16016, 15963, 15903, 15839, 15768, 15689, 15602, 15504, 15395, 15274, 15142, 14998, 14843, 14676, 14498, 14310, 14109, 13898, 13675, 13442, 13198, 12944, 12683, 12409, 12127, 11834, 11535, 11226, 10913, 10595, 10271, 9946, 9618, 9290, 8957, 8621, 8277, 7923, 7560, 7185, 6801, 6412, 6024, 5635, 5255, 4887, 4533, 4193, 3866, 3552, 3242, 2938, 2635, 2334, 2032, 1734, 1441, 1150, 869, 596, 335, 85, -151, -379, -598, -808, -1011, -1206, -1396, -1578, -1757, -1928, -2091, -2244, -2388, -2521, -2641, -2752, -2855, -2956, -3058, -3165, -3282, -3410, -3550, -3697, -3851, -4006, -4158, -4306, -4446, -4578, -4704, -4825, -4941, -5056, -5171, -5287, -5405, -5522, -5638, -5752, -5864, -5970, -6072, -6169, -6259, -6343, -6422, -6496, -6564, -6626, -6683, -6734, -6779, -6819, -6852, -6878, -6897, -6907, -6911, -6906, -6895, -6878, -6857, -6830, -6800, -6768, -6733, -6696, -6658, -6619, -6580, -6542, -6507, -6474, -6443, -6417, -6394, -6374, -6357, -6345, -6335, -6329, -6329, -6336, -6354, -6384, -6429, -6491, -6570, -6665, -6775, -6898, -7034, -7180, -7336, -7500, -7675, -7859, -8051, -8253, -8462, -8679, -8904, -9134, -9369, -9612, -9867, -10132, -10413, -10707, -11018, -11337, -11668, -12005, -12343, -12680, -13011, -13335, -13650, -13959, -14256, -14540, -14807, -15055, -15284, -15488, -15672, -15833, -15977, -16101, -16211, -16305, -16376, -16383, -16383, -16382, -16384, -16381, -16386, -16323, -16188, -16029, -15833, -15613, -15360, -15081, -14775, -14443, -14085, -13701, -13297, -12866, -12413, -11939, -11445, -10930, -10401, -9858, -9297, -8727, -8144, -7557, -6959, -6362, -5758, -5149, -4541, -3932, -3327, -2724, -2131, -1538, -950, -370};
static int16_t E4_FLAT_array[E4_FLAT_LENGTH] = {201, 806, 1402, 1991, 2568, 3131, 3685, 4221, 4742, 5244, 5730, 6194, 6645, 7076, 7492, 7887, 8267, 8626, 8969, 9297, 9611, 9911, 10199, 10475, 10737, 10992, 11235, 11473, 11702, 11926, 12147, 12361, 12572, 12779, 12983, 13180, 13378, 13570, 13761, 13948, 14130, 14305, 14473, 14633, 14785, 14929, 15064, 15191, 15310, 15423, 15527, 15624, 15714, 15795, 15869, 15936, 15995, 16047, 16094, 16132, 16163, 16187, 16202, 16208, 16205, 16192, 16169, 16138, 16099, 16052, 16000, 15941, 15876, 15804, 15725, 15636, 15536, 15423, 15298, 15160, 15009, 14844, 14667, 14476, 14275, 14060, 13833, 13592, 13340, 13075, 12802, 12517, 12221, 11913, 11597, 11271, 10939, 10602, 10258, 9913, 9564, 9215, 8860, 8503, 8132, 7753, 7361, 6958, 6545, 6133, 5720, 5314, 4922, 4545, 4184, 3838, 3505, 3177, 2855, 2534, 2214, 1894, 1582, 1271, 968, 675, 395, 127, -125, -368, -601, -824, -1038, -1244, -1444, -1636, -1823, -2001, -2170, -2327, -2473, -2605, -2725, -2836, -2943, -3051, -3165, -3289, -3427, -3576, -3735, -3899, -4063, -4223, -4376, -4520, -4656, -4786, -4911, -5033, -5155, -5278, -5404, -5527, -5651, -5771, -5889, -6001, -6108, -6207, -6300, -6386, -6467, -6541, -6610, -6671, -6727, -6775, -6818, -6853, -6880, -6899, -6909, -6910, -6903, -6889, -6869, -6843, -6813, -6779, -6743, -6705, -6664, -6623, -6582, -6541, -6504, -6469, -6437, -6410, -6387, -6367, -6351, -6339, -6331, -6328, -6333, -6349, -6378, -6423, -6487, -6571, -6672, -6790, -6923, -7070, -7228, -7397, -7576, -7766, -7965, -8175, -8396, -8624, -8861, -9104, -9353, -9610, -9881, -10164, -10465, -10780, -11113, -11455, -11811, -12169, -12529, -12882, -13230, -13566, -13897, -14214, -14518, -14801, -15066, -15305, -15521, -15710, -15877, -16021, -16149, -16256, -16350, -16385, -16382, -16383, -16384, -16382, -16386, -16328, -16183, -16014, -15801, -15563, -15285, -14982, -14645, -14282, -13887, -13469, -13022, -12549, -12051, -11531, -10987, -10427, -9850, -9255, -8647, -8028, -7402, -6767, -6132, -5487, -4841, -4195, -3551, -2909, -2276, -1648, -1022, -405};
static int16_t E4_array[E4_LENGTH] = {201, 840, 1471, 2092, 2699, 3292, 3873, 4434, 4977, 5500, 6002, 6483, 6947, 7391, 7814, 8218, 8601, 8964, 9312, 9642, 9958, 10260, 10548, 10823, 11088, 11343, 11591, 11829, 12064, 12293, 12518, 12737, 12954, 13163, 13372, 13576, 13777, 13975, 14166, 14349, 14525, 14692, 14849, 14996, 15135, 15264, 15386, 15499, 15604, 15700, 15787, 15866, 15937, 15999, 16054, 16101, 16141, 16171, 16194, 16206, 16207, 16199, 16180, 16150, 16111, 16064, 16009, 15948, 15880, 15804, 15720, 15625, 15517, 15396, 15259, 15109, 14943, 14764, 14569, 14361, 14139, 13903, 13652, 13389, 13111, 12822, 12521, 12208, 11882, 11545, 11199, 10847, 10488, 10123, 9756, 9388, 9015, 8638, 8252, 7853, 7441, 7017, 6581, 6145, 5708, 5279, 4866, 4471, 4092, 3731, 3381, 3037, 2697, 2358, 2019, 1685, 1356, 1033, 722, 422, 138, -129, -385, -631, -865, -1089, -1306, -1514, -1716, -1910, -2093, -2265, -2424, -2569, -2698, -2818, -2931, -3045, -3165, -3297, -3444, -3603, -3772, -3947, -4119, -4286, -4444, -4592, -4732, -4866, -4996, -5125, -5255, -5387, -5518, -5649, -5777, -5901, -6018, -6130, -6233, -6330, -6419, -6501, -6577, -6645, -6706, -6761, -6807, -6847, -6876, -6898, -6909, -6910, -6902, -6887, -6864, -6836, -6802, -6766, -6727, -6685, -6641, -6598, -6554, -6514, -6476, -6442, -6413, -6388, -6367, -6350, -6338, -6330, -6328, -6337, -6358, -6394, -6451, -6530, -6629, -6747, -6883, -7035, -7200, -7377, -7565, -7766, -7977, -8200, -8435, -8678, -8931, -9190, -9456, -9734, -10027, -10336, -10664, -11010, -11371, -11743, -12123, -12502, -12878, -13244, -13601, -13948, -14282, -14597, -14893, -15162, -15406, -15619, -15808, -15968, -16111, -16228, -16334, -16384, -16383, -16383, -16384, -16382, -16385, -16302, -16142, -15950, -15715, -15447, -15139, -14801, -14427, -14023, -13586, -13122, -12625, -12103, -11554, -10980, -10386, -9774, -9141, -8496, -7839, -7172, -6500, -5824, -5140, -4457, -3774, -3095, -2422, -1758, -1094, -441};
static int16_t F4_array[F4_LENGTH] = {201, 880, 1548, 2206, 2846, 3473, 4083, 4670, 5237, 5780, 6300, 6799, 7277, 7731, 8164, 8572, 8958, 9327, 9677, 10010, 10328, 10629, 10918, 11195, 11462, 11720, 11970, 12217, 12456, 12691, 12920, 13144, 13365, 13582, 13796, 14005, 14206, 14399, 14583, 14756, 14918, 15070, 15212, 15344, 15467, 15580, 15684, 15778, 15862, 15938, 16004, 16061, 16110, 16149, 16180, 16200, 16208, 16205, 16189, 16162, 16124, 16076, 16020, 15956, 15884, 15804, 15714, 15612, 15496, 15363, 15215, 15050, 14868, 14670, 14455, 14227, 13981, 13719, 13442, 13150, 12845, 12526, 12193, 11846, 11487, 11118, 10742, 10359, 9971, 9581, 9187, 8790, 8384, 7964, 7531, 7083, 6622, 6158, 5695, 5240, 4804, 4388, 3990, 3612, 3242, 2879, 2520, 2159, 1803, 1452, 1106, 774, 454, 151, -133, -405, -664, -910, -1147, -1374, -1592, -1803, -2004, -2192, -2367, -2526, -2668, -2796, -2917, -3038, -3165, -3305, -3463, -3634, -3815, -4000, -4181, -4356, -4518, -4671, -4815, -4955, -5092, -5229, -5369, -5508, -5647, -5782, -5914, -6038, -6154, -6262, -6362, -6454, -6538, -6614, -6683, -6743, -6795, -6839, -6873, -6896, -6909, -6910, -6901, -6883, -6858, -6827, -6791, -6751, -6708, -6662, -6616, -6570, -6525, -6485, -6448, -6416, -6389, -6366, -6349, -6337, -6329, -6329, -6342, -6370, -6417, -6488, -6584, -6701, -6840, -6996, -7169, -7354, -7553, -7766, -7991, -8229, -8479, -8739, -9010, -9287, -9574, -9876, -10196, -10536, -10897, -11275, -11668, -12070, -12473, -12872, -13261, -13639, -14006, -14356, -14686, -14990, -15267, -15510, -15724, -15907, -16066, -16197, -16314, -16381, -16383, -16383, -16383, -16383, -16379, -16272, -16093, -15875, -15611, -15310, -14966, -14587, -14169, -13717, -13231, -12712, -12160, -11580, -10970, -10340, -9687, -9013, -8325, -7625, -6914, -6200, -5477, -4751, -4026, -3303, -2586, -1880, -1176, -481};
static int16_t G4_FLAT_array[G4_FLAT_LENGTH] = {201, 918, 1623, 2317, 2990, 3649, 4286, 4898, 5487, 6049, 6587, 7101, 7589, 8053, 8491, 8903, 9295, 9666, 10018, 10353, 10670, 10973, 11263, 11543, 11812, 12075, 12332, 12582, 12828, 13066, 13301, 13532, 13758, 13980, 14193, 14397, 14591, 14773, 14943, 15102, 15249, 15386, 15512, 15628, 15733, 15827, 15910, 15984, 16046, 16100, 16144, 16177, 16199, 16208, 16204, 16186, 16156, 16114, 16060, 15998, 15927, 15848, 15758, 15656, 15539, 15405, 15253, 15082, 14892, 14685, 14459, 14217, 13956, 13677, 13382, 13069, 12743, 12401, 12042, 11670, 11284, 10890, 10488, 10078, 9667, 9252, 8832, 8404, 7961, 7502, 7027, 6539, 6049, 5560, 5086, 4633, 4201, 3792, 3398, 3012, 2631, 2250, 1872, 1500, 1134, 781, 444, 125, -173, -458, -729, -986, -1233, -1469, -1696, -1914, -2119, -2309, -2482, -2637, -2775, -2904, -3031, -3165, -3314, -3482, -3664, -3857, -4052, -4242, -4422, -4588, -4746, -4895, -5040, -5185, -5332, -5480, -5627, -5771, -5909, -6041, -6163, -6276, -6381, -6476, -6563, -6640, -6709, -6769, -6820, -6860, -6889, -6906, -6910, -6903, -6886, -6860, -6827, -6789, -6746, -6700, -6652, -6603, -6554, -6509, -6468, -6431, -6400, -6375, -6354, -6339, -6330, -6329, -6340, -6368, -6418, -6494, -6598, -6726, -6876, -7046, -7234, -7435, -7652, -7883, -8128, -8388, -8660, -8943, -9235, -9536, -9854, -10191, -10550, -10933, -11335, -11752, -12178, -12604, -13022, -13428, -13822, -14202, -14560, -14892, -15194, -15460, -15691, -15889, -16058, -16199, -16320, -16385, -16381, -16385, -16381, -16388, -16350, -16193, -15985, -15727, -15425, -15076, -14686, -14253, -13782, -13272, -12725, -12141, -11526, -10879, -10209, -9513, -8796, -8064, -7319, -6566, -5808, -5040, -4274, -3508, -2749, -2000, -1256, -520};
static int16_t G4_array[G4_LENGTH] = {201, 961, 1708, 2440, 3150, 3844, 4510, 5150, 5762, 6344, 6900, 7428, 7927, 8399, 8840, 9259, 9653, 10027, 10381, 10715, 11034, 11339, 11632, 11915, 12192, 12460, 12723, 12979, 13228, 13474, 13715, 13951, 14179, 14396, 14601, 14793, 14972, 15137, 15290, 15432, 15562, 15679, 15784, 15877, 15959, 16029, 16089, 16138, 16174, 16198, 16208, 16203, 16183, 16148, 16101, 16041, 15972, 15893, 15804, 15703, 15586, 15450, 15294, 15117, 14920, 14701, 14463, 14206, 13928, 13630, 13313, 12978, 12626, 12257, 11870, 11468, 11054, 10631, 10199, 9763, 9324, 8879, 8427, 7957, 7470, 6964, 6446, 5926, 5411, 4915, 4444, 3997, 3573, 3161, 2755, 2352, 1949, 1554, 1165, 790, 432, 96, -218, -518, -801, -1070, -1328, -1574, -1811, -2034, -2242, -2432, -2601, -2751, -2888, -3023, -3165, -3323, -3503, -3698, -3905, -4110, -4309, -4494, -4665, -4828, -4983, -5136, -5291, -5448, -5604, -5757, -5905, -6044, -6173, -6292, -6401, -6500, -6589, -6668, -6737, -6796, -6844, -6880, -6902, -6911, -6905, -6889, -6862, -6827, -6787, -6741, -6692, -6641, -6589, -6538, -6492, -6449, -6414, -6385, -6360, -6343, -6332, -6328, -6338, -6367, -6419, -6501, -6614, -6754, -6918, -7105, -7308, -7528, -7766, -8019, -8288, -8572, -8869, -9176, -9494, -9829, -10185, -10566, -10974, -11402, -11848, -12300, -12749, -13188, -13613, -14024, -14415, -14778, -15109, -15401, -15654, -15868, -16050, -16200, -16327, -16386, -16380, -16386, -16380, -16387, -16293, -16096, -15850, -15547, -15196, -14794, -14347, -13853, -13318, -12739, -12121, -11466, -10777, -10061, -9317, -8551, -7770, -6975, -6175, -5365, -4551, -3739, -2931, -2135, -1345, -564};
static int16_t A4_FLAT_array[A4_FLAT_LENGTH] = {201, 1005, 1796, 2568, 3317, 4044, 4741, 5408, 6042, 6644, 7217, 7757, 8267, 8742, 9190, 9611, 10009, 10384, 10738, 11074, 11395, 11702, 12000, 12291, 12572, 12848, 13115, 13377, 13634, 13886, 14130, 14362, 14581, 14785, 14975, 15150, 15310, 15458, 15593, 15714, 15821, 15914, 15995, 16063, 16120, 16163, 16193, 16207, 16205, 16185, 16150, 16099, 16036, 15961, 15876, 15779, 15667, 15536, 15383, 15208, 15009, 14787, 14541, 14275, 13986, 13673, 13340, 12986, 12613, 12221, 11809, 11380, 10939, 10488, 10028, 9565, 9097, 8623, 8133, 7623, 7093, 6545, 5995, 5448, 4922, 4423, 3952, 3505, 3069, 2641, 2214, 1790, 1374, 968, 581, 214, -125, -447, -751, -1038, -1312, -1573, -1823, -2059, -2276, -2473, -2647, -2800, -2943, -3088, -3246, -3427, -3628, -3844, -4063, -4275, -4473, -4656, -4828, -4993, -5155, -5320, -5486, -5651, -5811, -5964, -6107, -6239, -6358, -6467, -6565, -6651, -6726, -6790, -6842, -6880, -6903, -6911, -6903, -6883, -6852, -6813, -6768, -6718, -6664, -6609, -6554, -6504, -6458, -6419, -6387, -6361, -6343, -6331, -6329, -6342, -6378, -6442, -6541, -6672, -6833, -7020, -7228, -7455, -7701, -7966, -8248, -8547, -8860, -9187, -9523, -9881, -10262, -10674, -11112, -11574, -12050, -12529, -12999, -13456, -13896, -14318, -14708, -15066, -15379, -15650, -15876, -16067, -16221, -16349, -16386, -16382, -16383, -16386, -16357, -16185, -15947, -15645, -15287, -14872, -14407, -13888, -13323, -12709, -12051, -11352, -10616, -9850, -9054, -8236, -7401, -6556, -5703, -4840, -3980, -3122, -2276, -1439, -610};
static int16_t A4_array[A4_LENGTH] = {201, 1051, 1887, 2699, 3488, 4250, 4977, 5670, 6325, 6947, 7534, 8086, 8601, 9081, 9534, 9958, 10358, 10733, 11088, 11427, 11750, 12064, 12369, 12665, 12953, 13233, 13508, 13777, 14040, 14289, 14525, 14745, 14948, 15135, 15306, 15463, 15604, 15730, 15840, 15937, 16018, 16086, 16141, 16180, 16203, 16207, 16194, 16161, 16112, 16046, 15969, 15880, 15777, 15658, 15517, 15352, 15161, 14943, 14700, 14432, 14140, 13821, 13478, 13111, 12723, 12313, 11882, 11431, 10965, 10488, 10001, 9511, 9015, 8511, 7987, 7441, 6872, 6290, 5708, 5139, 4601, 4092, 3614, 3151, 2697, 2244, 1796, 1356, 928, 521, 138, -216, -550, -865, -1162, -1446, -1716, -1972, -2209, -2424, -2613, -2779, -2931, -3084, -3251, -3444, -3659, -3888, -4119, -4340, -4544, -4732, -4910, -5082, -5255, -5431, -5606, -5777, -5940, -6093, -6233, -6360, -6475, -6577, -6666, -6743, -6807, -6857, -6892, -6909, -6908, -6893, -6864, -6825, -6778, -6727, -6670, -6612, -6554, -6501, -6453, -6413, -6380, -6355, -6338, -6329, -6332, -6358, -6411, -6501, -6629, -6791, -6983, -7200, -7438, -7698, -7977, -8278, -8596, -8931, -9278, -9640, -10027, -10443, -10893, -11371, -11869, -12376, -12878, -13364, -13833, -14282, -14698, -15075, -15405, -15685, -15918, -16110, -16267, -16375, -16383, -16384, -16382, -16383, -16256, -16016, -15717, -15347, -14918, -14427, -13881, -13280, -12626, -11922, -11174, -10385, -9565, -8712, -7839, -6948, -6051, -5140, -4230, -3320, -2423, -1536, -658};
static int16_t B4_FLAT_array[B4_FLAT_LENGTH] = {201, 1104, 1988, 2847, 3678, 4477, 5236, 5957, 6635, 7277, 7877, 8439, 8958, 9446, 9900, 10328, 10727, 11104, 11462, 11804, 12135, 12456, 12768, 13070, 13365, 13654, 13935, 14206, 14461, 14700, 14918, 15119, 15301, 15468, 15616, 15748, 15862, 15961, 16042, 16110, 16160, 16194, 16207, 16201, 16172, 16124, 16058, 15978, 15884, 15776, 15648, 15496, 15315, 15107, 14868, 14600, 14304, 13981, 13628, 13249, 12844, 12417, 11963, 11487, 10993, 10488, 9971, 9450, 8923, 8384, 7821, 7234, 6622, 6004, 5390, 4805, 4253, 3737, 3242, 2760, 2279, 1803, 1336, 883, 454, 54, -315, -664, -990, -1299, -1593, -1871, -2131, -2367, -2575, -2754, -2917, -3079, -3257, -3462, -3694, -3938, -4182, -4411, -4621, -4815, -5001, -5183, -5369, -5555, -5738, -5913, -6078, -6227, -6362, -6483, -6590, -6682, -6762, -6825, -6873, -6901, -6911, -6901, -6876, -6838, -6791, -6736, -6678, -6616, -6555, -6498, -6448, -6406, -6374, -6349, -6334, -6328, -6342, -6383, -6462, -6583, -6746, -6942, -7169, -7419, -7694, -7990, -8311, -8651, -9010, -9381, -9775, -10196, -10655, -11147, -11668, -12204, -12741, -13260, -13763, -14241, -14687, -15085, -15434, -15722, -15965, -16154, -16316, -16385, -16383, -16381, -16388, -16320, -16091, -15793, -15413, -14967, -14451, -13872, -13231, -12532, -11776, -10971, -10124, -9240, -8324, -7389, -6438, -5478, -4509, -3544, -2586, -1645, -711};
static int16_t B4_array[B4_LENGTH] = {202, 1157, 2092, 2998, 3873, 4708, 5500, 6245, 6947, 7605, 8218, 8784, 9311, 9802, 10260, 10687, 11088, 11468, 11829, 12179, 12518, 12846, 13164, 13474, 13777, 14071, 14349, 14610, 14849, 15067, 15265, 15444, 15604, 15745, 15866, 15969, 16054, 16122, 16171, 16201, 16207, 16191, 16150, 16089, 16009, 15915, 15804, 15674, 15517, 15329, 15109, 14855, 14569, 14252, 13903, 13522, 13111, 12673, 12208, 11715, 11199, 10668, 10123, 9572, 9015, 8446, 7853, 7230, 6582, 5926, 5279, 4666, 4092, 3555, 3037, 2527, 2019, 1520, 1033, 570, 138, -259, -631, -978, -1306, -1616, -1909, -2180, -2424, -2635, -2817, -2988, -3165, -3369, -3603, -3859, -4119, -4366, -4592, -4800, -4996, -5190, -5387, -5584, -5777, -5960, -6129, -6282, -6419, -6540, -6645, -6734, -6807, -6863, -6897, -6911, -6902, -6876, -6835, -6785, -6727, -6663, -6597, -6534, -6476, -6427, -6388, -6358, -6338, -6328, -6337, -6374, -6451, -6577, -6747, -6957, -7200, -7469, -7765, -8088, -8434, -8803, -9190, -9594, -10027, -10498, -11010, -11556, -12123, -12691, -13244, -13776, -14282, -14747, -15162, -15516, -15807, -16042, -16231, -16365, -16386, -16381, -16387, -16353, -16145, -15837, -15446, -14974, -14427, -13808, -13121, -12368, -11553, -10685, -9773, -8820, -7838, -6837, -5823, -4799, -3774, -2757, -1757, -767};
static int16_t C5_array[C5_LENGTH] = {202, 1211, 2198, 3151, 4069, 4940, 5762, 6532, 7255, 7928, 8549, 9122, 9653, 10147, 10606, 11034, 11438, 11821, 12191, 12548, 12894, 13229, 13555, 13873, 14179, 14465, 14731, 14972, 15190, 15386, 15562, 15716, 15848, 15959, 16051, 16123, 16174, 16203, 16206, 16183, 16134, 16062, 15972, 15865, 15738, 15586, 15400, 15178, 14920, 14624, 14294, 13928, 13526, 13092, 12626, 12130, 11604, 11054, 10487, 9909, 9323, 8730, 8115, 7470, 6792, 6099, 5411, 4755, 4144, 3573, 3025, 2486, 1950, 1423, 914, 432, -11, -420, -802, -1157, -1493, -1810, -2105, -2370, -2601, -2797, -2978, -3165, -3381, -3632, -3905, -4177, -4434, -4665, -4880, -5085, -5292, -5500, -5707, -5904, -6088, -6253, -6401, -6531, -6643, -6737, -6814, -6869, -6902, -6910, -6896, -6862, -6815, -6757, -6693, -6623, -6555, -6491, -6437, -6393, -6361, -6338, -6329, -6338, -6382, -6470, -6614, -6806, -7041, -7308, -7606, -7932, -8289, -8669, -9073, -9493, -9945, -10436, -10974, -11549, -12149, -12749, -13332, -13888, -14416, -14891, -15309, -15652, -15934, -16151, -16328, -16387, -16381, -16385, -16367, -16171, -15847, -15437, -14932, -14347, -13679, -12937, -12121, -11240, -10302, -9318, -8293, -7242, -6174, -5094, -4009, -2932, -1871, -823};
static int16_t D5_FLAT_array[D5_FLAT_LENGTH] = {201, 1272, 2316, 3322, 4286, 5196, 6049, 6847, 7589, 8275, 8903, 9482, 10018, 10514, 10973, 11404, 11812, 12205, 12583, 12948, 13301, 13645, 13979, 14297, 14591, 14860, 15102, 15319, 15512, 15682, 15827, 15948, 16047, 16123, 16177, 16205, 16204, 16173, 16113, 16030, 15927, 15804, 15656, 15474, 15252, 14990, 14684, 14340, 13956, 13531, 13070, 12573, 12042, 11478, 10890, 10284, 9666, 9043, 8404, 7734, 7027, 6294, 5561, 4856, 4202, 3593, 3012, 2440, 1872, 1316, 781, 282, -174, -595, -986, -1352, -1696, -2018, -2309, -2562, -2775, -2967, -3165, -3396, -3664, -3955, -4242, -4507, -4745, -4968, -5185, -5406, -5627, -5841, -6041, -6221, -6380, -6520, -6640, -6740, -6820, -6876, -6906, -6908, -6886, -6845, -6788, -6724, -6652, -6579, -6509, -6449, -6400, -6364, -6339, -6329, -6340, -6390, -6494, -6659, -6876, -7138, -7435, -7766, -8128, -8523, -8943, -9384, -9853, -10368, -10932, -11543, -12178, -12815, -13427, -14015, -14559, -15048, -15459, -15796, -16055, -16266, -16381, -16383, -16383, -16378, -16199, -15859, -15426, -14885, -14255, -13531, -12726, -11837, -10881, -9863, -8797, -7692, -6567, -5424, -4274, -3127, -2000, -886};
static int16_t D5_array[D5_LENGTH] = {202, 1333, 2435, 3493, 4503, 5449, 6334, 7155, 7916, 8610, 9245, 9829, 10368, 10863, 11326, 11760, 12177, 12578, 12964, 13337, 13700, 14051, 14381, 14684, 14959, 15203, 15421, 15611, 15775, 15912, 16023, 16110, 16171, 16204, 16204, 16171, 16107, 16016, 15904, 15768, 15602, 15395, 15142, 14843, 14498, 14110, 13676, 13198, 12682, 12127, 11534, 10913, 10272, 9618, 8958, 8277, 7560, 6801, 6023, 5255, 4533, 3867, 3243, 2635, 2033, 1440, 869, 334, -151, -598, -1011, -1395, -1757, -2091, -2388, -2642, -2855, -3058, -3282, -3550, -3851, -4159, -4446, -4704, -4941, -5171, -5405, -5638, -5863, -6073, -6259, -6422, -6564, -6683, -6779, -6852, -6896, -6911, -6895, -6857, -6800, -6733, -6658, -6580, -6506, -6443, -6394, -6358, -6335, -6329, -6354, -6429, -6570, -6775, -7034, -7336, -7674, -8052, -8462, -8904, -9369, -9867, -10413, -11017, -11668, -12344, -13011, -13652, -14256, -14808, -15282, -15673, -15975, -16214, -16367, -16386, -16381, -16381, -16195, -15832, -15362, -14774, -14086, -13295, -12414, -11443, -10402, -9298, -8145, -6961, -5758, -4540, -3326, -2129, -951};
static int16_t E5_FLAT_array[E5_FLAT_LENGTH] = {202, 1403, 2567, 3684, 4742, 5729, 6645, 7491, 8266, 8969, 9611, 10199, 10738, 11236, 11702, 12146, 12573, 12982, 13377, 13761, 14130, 14473, 14785, 15064, 15311, 15527, 15714, 15869, 15995, 16093, 16163, 16202, 16205, 16169, 16099, 16000, 15876, 15725, 15536, 15298, 15009, 14667, 14275, 13832, 13340, 12802, 12221, 11596, 10939, 10259, 9564, 8861, 8133, 7361, 6546, 5720, 4922, 4184, 3504, 2855, 2214, 1581, 968, 394, -126, -601, -1038, -1444, -1823, -2170, -2473, -2725, -2943, -3165, -3427, -3735, -4063, -4376, -4656, -4911, -5155, -5403, -5651, -5889, -6107, -6300, -6467, -6609, -6726, -6818, -6880, -6909, -6903, -6869, -6813, -6743, -6664, -6581, -6504, -6438, -6387, -6351, -6331, -6333, -6378, -6487, -6672, -6923, -7228, -7576, -7966, -8395, -8861, -9353, -9881, -10465, -11112, -11811, -12528, -13229, -13896, -14517, -15065, -15521, -15876, -16149, -16344, -16389, -16379, -16384, -16191, -15800, -15288, -14645, -13889, -13021, -12052, -10987, -9850, -8647, -7402, -6130, -4842, -3549, -2276, -1023};
static int16_t E5_array[E5_LENGTH] = {202, 1471, 2700, 3872, 4977, 6001, 6947, 7814, 8601, 9311, 9958, 10548, 11088, 11590, 12064, 12518, 12953, 13371, 13777, 14166, 14525, 14849, 15135, 15386, 15604, 15787, 15937, 16054, 16140, 16194, 16208, 16180, 16111, 16009, 15880, 15720, 15517, 15260, 14944, 14569, 14139, 13652, 13111, 12521, 11882, 11199, 10487, 9756, 9015, 8252, 7441, 6582, 5708, 4866, 4093, 3381, 2697, 2020, 1356, 721, 138, -385, -865, -1305, -1716, -2093, -2424, -2698, -2931, -3165, -3444, -3773, -4119, -4444, -4732, -4996, -5255, -5519, -5777, -6018, -6233, -6419, -6577, -6706, -6808, -6877, -6909, -6902, -6864, -6802, -6727, -6641, -6555, -6476, -6413, -6367, -6338, -6329, -6357, -6451, -6629, -6883, -7200, -7565, -7978, -8434, -8930, -9456, -10027, -10664, -11371, -12123, -12878, -13601, -14281, -14892, -15405, -15807, -16109, -16330, -16390, -16379, -16379, -16148, -15714, -15141, -14427, -13587, -12626, -11553, -10386, -9142, -7838, -6501, -5141, -3773, -2423, -1095};
static int16_t F5_array[F5_LENGTH] = {202, 1548, 2847, 4082, 5237, 6300, 7277, 8163, 8959, 9677, 10328, 10918, 11462, 11971, 12456, 12920, 13365, 13796, 14206, 14582, 14918, 15212, 15467, 15684, 15863, 16004, 16110, 16179, 16208, 16189, 16124, 16020, 15884, 15714, 15496, 15215, 14868, 14456, 13981, 13442, 12845, 12193, 11487, 10742, 9971, 9187, 8384, 7531, 6623, 5694, 4804, 3991, 3243, 2519, 1803, 1107, 454, -133, -664, -1147, -1593, -2004, -2367, -2668, -2917, -3165, -3462, -3815, -4182, -4518, -4815, -5092, -5368, -5647, -5913, -6154, -6362, -6538, -6683, -6795, -6873, -6909, -6901, -6858, -6790, -6708, -6616, -6525, -6448, -6389, -6349, -6329, -6342, -6417, -6583, -6840, -7168, -7553, -7991, -8479, -9009, -9575, -10196, -10897, -11668, -12473, -13261, -14005, -14687, -15266, -15725, -16063, -16313, -16390, -16380, -16371, -16097, -15611, -14967, -14169, -13231, -12160, -10971, -9686, -8325, -6915, -5477, -4025, -2588, -1176};
static int16_t G5_FLAT_array[G5_FLAT_LENGTH] = {202, 1624, 2991, 4286, 5487, 6587, 7589, 8491, 9294, 10018, 10670, 11263, 11812, 12332, 12827, 13301, 13758, 14193, 14591, 14944, 15249, 15513, 15733, 15910, 16046, 16144, 16199, 16204, 16156, 16060, 15927, 15758, 15539, 15253, 14892, 14459, 13956, 13381, 12743, 12042, 11284, 10487, 9666, 8832, 7961, 7027, 6048, 5086, 4201, 3398, 2630, 1872, 1134, 444, -174, -729, -1233, -1696, -2119, -2482, -2775, -3030, -3314, -3664, -4052, -4421, -4746, -5040, -5332, -5627, -5909, -6163, -6381, -6562, -6709, -6820, -6889, -6910, -6886, -6827, -6746, -6652, -6555, -6467, -6400, -6354, -6330, -6340, -6418, -6597, -6877, -7233, -7652, -8128, -8661, -9234, -9854, -10550, -11336, -12178, -13023, -13822, -14561, -15192, -15693, -16055, -16319, -16388, -16385, -16341, -15985, -15425, -14685, -13783, -12724, -11526, -10208, -8797, -7319, -5807, -4273, -2750, -1255};
static int16_t G5_array[G5_LENGTH] = {203, 1707, 3152, 4510, 5762, 6899, 7928, 8840, 9654, 10380, 11034, 11631, 12191, 12722, 13229, 13715, 14179, 14601, 14972, 15290, 15562, 15784, 15959, 16089, 16174, 16208, 16183, 16101, 15972, 15804, 15586, 15294, 14920, 14463, 13928, 13313, 12626, 11870, 11054, 10199, 9323, 8426, 7470, 6446, 5411, 4444, 3573, 2755, 1950, 1166, 432, -219, -801, -1328, -1810, -2242, -2601, -2888, -3165, -3502, -3905, -4308, -4666, -4983, -5292, -5604, -5905, -6173, -6401, -6589, -6737, -6844, -6902, -6905, -6862, -6786, -6693, -6588, -6492, -6413, -6361, -6331, -6339, -6419, -6614, -6918, -7309, -7765, -8289, -8868, -9495, -10184, -10974, -11846, -12750, -13612, -14416, -15106, -15656, -16046, -16326, -16385, -16389, -16291, -15846, -15198, -14344, -13319, -12120, -10779, -9316, -7771, -6174, -4552, -2932, -1346};
static int16_t A5_FLAT_array[A5_FLAT_LENGTH] = {201, 1803, 3331, 4761, 6064, 7243, 8292, 9218, 10037, 10767, 11423, 12030, 12603, 13147, 13667, 14163, 14611, 15004, 15335, 15615, 15838, 16010, 16129, 16198, 16201, 16140, 16018, 15853, 15635, 15339, 14949, 14468, 13896, 13235, 12493, 11673, 10790, 9872, 8932, 7953, 6893, 5788, 4726, 3774, 2896, 2039, 1200, 420, -270, -881, -1433, -1935, -2373, -2723, -3014, -3334, -3738, -4175, -4573, -4917, -5246, -5578, -5900, -6184, -6424, -6617, -6767, -6867, -6910, -6891, -6828, -6735, -6628, -6519, -6431, -6368, -6334, -6336, -6421, -6632, -6969, -7394, -7899, -8473, -9111, -9799, -10586, -11478, -12438, -13372, -14247, -15007, -15613, -16037, -16332, -16384, -16391, -16217, -15673, -14917, -13930, -12759, -11395, -9894, -8272, -6589, -4863, -3140, -1445};
static int16_t A5_array[A5_LENGTH] = {203, 1893, 3504, 4997, 6351, 7561, 8630, 9563, 10388, 11118, 11782, 12400, 12986, 13542, 14074, 14558, 14979, 15333, 15627, 15859, 16033, 16149, 16206, 16188, 16098, 15948, 15749, 15476, 15105, 14627, 14049, 13369, 12599, 11739, 10808, 9835, 8841, 7794, 6659, 5490, 4399, 3428, 2512, 1611, 751, -19, -692, -1294, -1837, -2315, -2696, -3006, -3345, -3776, -4236, -4647, -5003, -5353, -5702, -6030, -6308, -6537, -6714, -6840, -6904, -6900, -6840, -6746, -6632, -6518, -6425, -6363, -6330, -6348, -6471, -6744, -7140, -7631, -8202, -8852, -9557, -10353, -11271, -12278, -13275, -14206, -15016, -15645, -16085, -16358, -16383, -16377, -16055, -15382, -14475, -13326, -11973, -10432, -8755, -6983, -5168, -3338, -1544};
static int16_t B5_FLAT_array[B5_FLAT_LENGTH] = {204, 1977, 3663, 5213, 6610, 7847, 8929, 9868, 10697, 11429, 12103, 12732, 13330, 13898, 14427, 14885, 15273, 15591, 15843, 16027, 16152, 16206, 16181, 16075, 15909, 15682, 15367, 14936, 14392, 13735, 12972, 12108, 11157, 10145, 9107, 8025, 6849, 5619, 4463, 3437, 2475, 1529, 635, -157, -846, -1460, -2011, -2479, -2839, -3165, -3573, -4056, -4512, -4901, -5266, -5636, -5985, -6285, -6528, -6716, -6846, -6907, -6894, -6822, -6717, -6595, -6481, -6395, -6343, -6330, -6402, -6624, -7000, -7487, -8067, -8734, -9468, -10290, -11253, -12307, -13357, -14318, -15150, -15758, -16190, -16381, -16389, -16293, -15754, -14924, -13820, -12481, -10919, -9195, -7349, -5449, -3523, -1635};
static int16_t B5_array[B5_LENGTH] = {201, 2092, 3872, 5500, 6946, 8218, 9310, 10261, 11087, 11831, 12517, 13165, 13777, 14350, 14848, 15265, 15603, 15867, 16054, 16172, 16207, 16151, 16009, 15805, 15517, 15109, 14569, 13903, 13111, 12207, 11200, 10123, 9015, 7853, 6582, 5280, 4093, 3037, 2020, 1033, 139, -630, -1306, -1909, -2424, -2818, -3165, -3603, -4119, -4593, -4996, -5387, -5777, -6130, -6419, -6645, -6807, -6898, -6902, -6836, -6726, -6598, -6475, -6389, -6337, -6338, -6450, -6748, -7198, -7767, -8433, -9191, -10025, -11012, -12120, -13248, -14277, -15168, -15800, -16241, -16385, -16391, -16156, -15438, -14433, -13117, -11557, -9769, -7841, -5820, -3776, -1754};
static int16_t C6_array[C6_LENGTH] = {203, 2196, 4069, 5761, 7256, 8548, 9654, 10606, 11438, 12191, 12894, 13555, 14179, 14730, 15190, 15561, 15848, 16050, 16174, 16206, 16134, 15972, 15738, 15400, 14920, 14294, 13527, 12626, 11605, 10486, 9324, 8115, 6793, 5411, 4144, 3025, 1951, 913, -10, -801, -1493, -2105, -2601, -2978, -3381, -3905, -4433, -4880, -5291, -5707, -6088, -6401, -6642, -6814, -6902, -6896, -6814, -6692, -6554, -6437, -6360, -6329, -6381, -6614, -7040, -7606, -8288, -9072, -9944, -10974, -12148, -13333, -14413, -15309, -15932, -16318, -16392, -16347, -15858, -14928, -13683, -12119, -10304, -8291, -6175, -4008, -1871};
static int16_t NO_NOTE_array[NO_NOTE_LENGTH] = {0, 0};

static int16_t* note_arrays[27] = {
    B3_array,
    C4_array,
    D4_FLAT_array,
    D4_array,
    E4_FLAT_array,
    E4_array,
    F4_array,
    G4_FLAT_array,
    G4_array,
    A4_FLAT_array,
    A4_array,
    B4_FLAT_array,
    B4_array,
    C5_array,
    D5_FLAT_array,
    D5_array,
    E5_FLAT_array,
    E5_array,
    F5_array,
    G5_FLAT_array,
    G5_array,
    A5_FLAT_array,
    A5_array,
    B5_FLAT_array,
    B5_array,
    C6_array,
    NO_NOTE_array
};
static const int note_lengths[27] = {
    B3_LENGTH,
    C4_LENGTH,
    D4_FLAT_LENGTH,
    D4_LENGTH,
    E4_FLAT_LENGTH,
    E4_LENGTH,
    F4_LENGTH,
    G4_FLAT_LENGTH,
    G4_LENGTH,
    A4_FLAT_LENGTH,
    A4_LENGTH,
    B4_FLAT_LENGTH,
    B4_LENGTH,
    C5_LENGTH,
    D5_FLAT_LENGTH,
    D5_LENGTH,
    E5_FLAT_LENGTH,
    E5_LENGTH,
    F5_LENGTH,
    G5_FLAT_LENGTH,
    G5_LENGTH,
    A5_FLAT_LENGTH,
    A5_LENGTH,
    B5_FLAT_LENGTH,
    B5_LENGTH,
    C6_LENGTH,
    NO_NOTE_LENGTH
};
static int current_note_array_locations[26] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};


static musical_note_t current_notes[NUMBER_OF_NOTE_INDICES];
static int16_t tx_buffer[BUFFER_LENGTH] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
///static int16_t tx_buffer_1[BUFFER_LENGTH] = {0};

// static bool is_buffer_1_tx = false;

int16_t get_next_note_in_array(musical_note_t note) {
    const int16_t* note_array = note_arrays[note];
    int note_array_length = note_lengths[note];
    int current_note_array_location = current_note_array_locations[note];
    int16_t result = note_array[current_note_array_location];
    current_note_array_locations[note] = (current_note_array_locations[note] + 1) % note_array_length;
    return result;
}

static void update_tx_buffer(int16_t *buffer) {
    int i;
    int j;
    for (i = 0; i < NUMBER_OF_NOTE_INDICES; i++) {
        for (j = 0; j < BUFFER_LENGTH; j++) {
            if (i == 0) {
                buffer[j] = 0;
            }
            buffer[j] += get_next_note_in_array(current_notes[i]);
        }
    }
    // printf("START OF BUFFER\n");
    // for (i = 0; i < BUFFER_LENGTH; i++) {
    //     printf("%d ", buffer[i]);
    // }
    // printf("END OF BUFFER\n");
}

static nrfx_i2s_buffers_t const i2s_buffers = {NULL, (uint32_t*) tx_buffer};

static void data_handler(nrfx_i2s_buffers_t const *p_released, uint32_t status) {
    //printf("data_handler\n");
    //is_buffer_1_tx  = !is_buffer_1_tx;
    //int16_t *other_buffer = 
    //i2s_buffers.p_tx_buffer = (uint32_t*) (is_buffer_1_tx ? tx_buffer_0 : tx_buffer_1);
    update_tx_buffer((int16_t *) (p_released->p_tx_buffer));
    nrfx_i2s_next_buffers_set(&i2s_buffers);
    
}

void i2s_instrument_init() {
    nrfx_i2s_config_t config = NRF_DRV_I2S_DEFAULT_CONFIG;
    config.sck_pin = SCK_PIN;
    config.lrck_pin = LRCK_PIN;
    config.sdout_pin = SDOUT_PIN;
    config.sdin_pin = NRFX_I2S_PIN_NOT_USED;
    config.channels = NRF_I2S_CHANNELS_LEFT;
    config.mck_setup = NRF_I2S_MCK_32MDIV11; // 2.909 MHz
    config.ratio = NRF_I2S_RATIO_32X; // Divide by 32
    APP_ERROR_CHECK(nrfx_i2s_init(&config, data_handler));
    //printf("In\n");
    nrfx_err_t start_err_code;
    start_err_code = nrfx_i2s_start(&i2s_buffers, BUFFER_LENGTH/2, 0);
    printf("nrfx_i2s_start error code: %ld\n", start_err_code);
    //printf("Out\n");
}

void i2s_instrument_init_hal() {
    // Enable transmission
    NRF_I2S->CONFIG.TXEN = (I2S_CONFIG_TXEN_TXEN_ENABLE << I2S_CONFIG_TXEN_TXEN_Pos);

    // Enable MCK generator
    NRF_I2S->CONFIG.MCKEN = (I2S_CONFIG_MCKEN_MCKEN_ENABLE << I2S_CONFIG_MCKEN_MCKEN_Pos);

    // MCKFREQ = 2.909 MHz
    NRF_I2S->CONFIG.MCKFREQ = I2S_CONFIG_MCKFREQ_MCKFREQ_32MDIV11 << I2S_CONFIG_MCKFREQ_MCKFREQ_Pos;

    // Ratio = 32 
    NRF_I2S->CONFIG.RATIO = I2S_CONFIG_RATIO_RATIO_32X << I2S_CONFIG_RATIO_RATIO_Pos;

    // Master mode, 16Bit, left aligned
    NRF_I2S->CONFIG.MODE = I2S_CONFIG_MODE_MODE_MASTER << I2S_CONFIG_MODE_MODE_Pos;
    NRF_I2S->CONFIG.SWIDTH = I2S_CONFIG_SWIDTH_SWIDTH_16BIT << I2S_CONFIG_SWIDTH_SWIDTH_Pos;
    NRF_I2S->CONFIG.ALIGN = I2S_CONFIG_ALIGN_ALIGN_LEFT << I2S_CONFIG_ALIGN_ALIGN_Pos;

    // Format = I2S
    NRF_I2S->CONFIG.FORMAT = I2S_CONFIG_FORMAT_FORMAT_I2S << I2S_CONFIG_FORMAT_FORMAT_Pos;

    // Use left channel 
    NRF_I2S->CONFIG.CHANNELS = I2S_CONFIG_CHANNELS_CHANNELS_LEFT << I2S_CONFIG_CHANNELS_CHANNELS_Pos;

    // Configure pins
    NRF_I2S->PSEL.MCK = (MCK_PIN << I2S_PSEL_MCK_PIN_Pos);
    NRF_I2S->PSEL.SCK = (SCK_PIN << I2S_PSEL_SCK_PIN_Pos); 
    NRF_I2S->PSEL.LRCK = (LRCK_PIN << I2S_PSEL_LRCK_PIN_Pos); 
    NRF_I2S->PSEL.SDOUT = (SDOUT_PIN << I2S_PSEL_SDOUT_PIN_Pos);

    NRF_I2S->ENABLE = 1;

    // Configure data pointer
    NRF_I2S->TXD.PTR = (uint32_t)NO_NOTE_array;
    NRF_I2S->RXTXD.MAXCNT = 1;

    // Start transmitting I2S data
    NRF_I2S->TASKS_START = 1;
}

void i2s_instrument_play(instrument_state_t *state) {
    int i;
    for (i = 0; i < NUMBER_OF_NOTE_INDICES; i++) {
       current_notes[i] = state->notes_to_play[i];
    }
    //printf("line 251\n");
    //nrf_delay_ms(1000);
}

static void play_wave_hal(musical_note_t note) {
    NRF_I2S->TXD.PTR = (uint32_t)&note_arrays[note][0];
    NRF_I2S->RXTXD.MAXCNT = (int)(note_lengths[note]/2);
}

// static void play_wave(int16_t wave_array[], size_t array_size) {
//     // Configure data pointer
//     NRF_I2S->TXD.PTR = (uint32_t)wave_array;
//     NRF_I2S->RXTXD.MAXCNT = (int)(array_size/2);
// }

void i2s_instrument_play_hal(instrument_state_t *state) {
    //printf("In play fn\n");
    int i = 0;
    //bool still_looking = true;
    while (i < NUMBER_OF_NOTE_INDICES) {
        if (state->notes_to_play[i]!= NO_NOTE) {
            printf("note: %d\n", state->notes_to_play[i]);
            play_wave_hal(state->notes_to_play[i]);
            break;
        }
        if (i == NUMBER_OF_NOTE_INDICES - 1) {
            play_wave_hal(NO_NOTE);
        }
        i++;
    }

    //play_wave_hal(B3);
    //play_wave_hal(G4_FLAT_array, ARRAY_SIZE(G4_FLAT_array));
    //NRF_I2S->TXD.PTR = (uint32_t)C4_array;
    //NRF_I2S->RXTXD.MAXCNT = C4_LENGTH/2;
    //play_wave(B3_array, ARRAY_SIZE(B3_array));
}
